apiVersion: v1
kind: ConfigMap
metadata:
  name: hec-sink-server
  namespace: gateway-demo
data:
  server.py: |-
    import os
    import json
    from http.server import BaseHTTPRequestHandler, HTTPServer

    TOKEN = os.getenv("HEC_TOKEN", "dev-token")

    HEC_HEALTH_PAYLOAD = {"text": "HEC is healthy", "code": 17}

    class Handler(BaseHTTPRequestHandler):
      def _send(self, code, payload):
        body = json.dumps(payload).encode("utf-8")
        self.send_response(code)
        self.send_header("Content-Type", "application/json")
        self.send_header("Content-Length", str(len(body)))
        self.end_headers()
        self.wfile.write(body)

      def do_GET(self):
        # Lightweight probe endpoints for Kubernetes
        if self.path in ("/healthz", "/readyz", "/"):
          return self._send(200, {"status": "ok"})

        # Splunk HEC health endpoints (Vector uses these for sink healthchecks)
        if self.path in ("/services/collector/health", "/services/collector/health/1.0"):
          return self._send(200, HEC_HEALTH_PAYLOAD)

        return self._send(404, {"error": "not found"})

      def do_POST(self):
        auth = self.headers.get("Authorization", "")
        expected = f"Splunk {TOKEN}"
        if TOKEN and auth.strip() != expected:
          print(f"AUTH FAIL: got '{auth}', expected '{expected}'", flush=True)
          return self._send(403, {"text": "Forbidden", "code": 4})

        length = int(self.headers.get("Content-Length", "0"))
        body = self.rfile.read(length).decode("utf-8", errors="replace")

        print(f"HEC POST {self.path} len={length}", flush=True)
        print(body, flush=True)

        return self._send(200, {"text": "Success", "code": 0})

    if __name__ == "__main__":
      port = int(os.getenv("PORT", "8088"))
      print(f"Starting mock HEC sink on 0.0.0.0:{port}", flush=True)
      HTTPServer(("0.0.0.0", port), Handler).serve_forever()
