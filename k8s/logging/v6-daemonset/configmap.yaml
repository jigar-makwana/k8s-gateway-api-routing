apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-config
  namespace: gateway-demo
data:
  vector.toml: |
    # v6: DaemonSet log shipper (Vector).
    # Collect node container logs + ship to the in-cluster mock HEC sink (hec-sink).
    #
    # Important:
    # - The kubernetes_logs source enriches events under `.kubernetes.*`
    # - Namespace field is `.kubernetes.pod_namespace` (not `.kubernetes.namespace`)
    # - We filter to *echo-api container logs* to avoid feedback loops (shipping hec-sink logs into hec-sink).

    [sources.k8s]
    type = "kubernetes_logs"
    self_node_name = "${VECTOR_SELF_NODE_NAME}"

    [transforms.only_echo_api]
    type = "remap"
    inputs = ["k8s"]
    source = '''
    if !exists(.kubernetes) { abort }
    if !exists(.kubernetes.pod_namespace) || .kubernetes.pod_namespace != "gateway-demo" { abort }
    if !exists(.kubernetes.container_name) || .kubernetes.container_name != "echo-api" { abort }
    '''

    [sinks.hec]
    type = "splunk_hec_logs"
    inputs = ["only_echo_api"]
    endpoint = "http://hec-sink.gateway-demo.svc.cluster.local:8088"
    endpoint_target = "event"
    default_token = "${HEC_TOKEN}"

    [sinks.hec.encoding]
    codec = "json"
