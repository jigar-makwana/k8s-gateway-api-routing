apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: vector
  namespace: gateway-demo
  labels:
    app: vector
    component: logging
spec:
  selector:
    matchLabels:
      app: vector
  template:
    metadata:
      labels:
        app: vector
        component: logging
    spec:
      serviceAccountName: vector

      # kind is often single-node and tainted as control-plane; tolerate so DS schedules.
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/master"
          operator: "Exists"
          effect: "NoSchedule"

      containers:
        - name: vector
          image: timberio/vector:0.45.0-alpine
          imagePullPolicy: IfNotPresent
          args: ["--config", "/etc/vector/vector.toml"]
          env:
            - name: VECTOR_SELF_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: HEC_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hec-token
                  key: HEC_TOKEN
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 250m
              memory: 256Mi
          securityContext:
            # Reading hostPath logs is easiest as root in local clusters.
            runAsUser: 0
          volumeMounts:
            - name: vector-config
              mountPath: /etc/vector
              readOnly: true
            - name: varlogcontainers
              mountPath: /var/log/containers
              readOnly: true
            - name: varlogpods
              mountPath: /var/log/pods
              readOnly: true
      volumes:
        - name: vector-config
          configMap:
            name: vector-config
        - name: varlogcontainers
          hostPath:
            path: /var/log/containers
        - name: varlogpods
          hostPath:
            path: /var/log/pods
